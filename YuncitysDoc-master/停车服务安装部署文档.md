###### <sub>YunParking</sub><br />停车服务安装部署文档<br />──<br /><sup>V1.0</sup><br />`#2023#`<br /><br /><br />****<br />*深圳市云创智城科技有限公司*

[TOC]

# 服务器相关准备

## lrzsz文件上传传输安装

- 上传与下载文件的命令

> yum -y install lrzsz

## 硬盘挂载操作说明

```shell
[root@localhost ~]# df -h
文件系统        容量  已用  可用 已用% 挂载点
devtmpfs        7.8G     0  7.8G    0% /dev
tmpfs           7.8G     0  7.8G    0% /dev/shm
tmpfs           7.8G   25M  7.8G    1% /run
tmpfs           7.8G     0  7.8G    0% /sys/fs/cgroup
/dev/sda3        36G  1.8G   34G    5% /
/dev/sda1       477M  113M  336M   26% /boot
tmpfs           1.6G     0  1.6G    0% /run/user/0
[root@localhost ~]# fdisk -l

磁盘 /dev/sda：42.9 GB, 42949672960 字节，83886080 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x000b3c11

   设备 Boot      Start         End      Blocks   Id  System
/dev/sda1   *        2048     1026047      512000   83  Linux
/dev/sda2         1026048     9414655     4194304   82  Linux swap / Solaris
/dev/sda3         9414656    83886079    37235712   83  Linux

磁盘 /dev/sdb：322.1 GB, 322122547200 字节，629145600 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节

[root@localhost ~]# fdisk /dev/sdb
欢迎使用 fdisk (util-linux 2.23.2)。

更改将停留在内存中，直到您决定将更改写入磁盘。
使用写入命令前请三思。

Device does not contain a recognized partition table
使用磁盘标识符 0x3d7760d6 创建新的 DOS 磁盘标签。

命令(输入 m 获取帮助)：m
命令操作
   a   toggle a bootable flag
   b   edit bsd disklabel
   c   toggle the dos compatibility flag
   d   delete a partition
   g   create a new empty GPT partition table
   G   create an IRIX (SGI) partition table
   l   list known partition types
   m   print this menu
   n   add a new partition
   o   create a new empty DOS partition table
   p   print the partition table
   q   quit without saving changes
   s   create a new empty Sun disklabel
   t   change a partition's system id
   u   change display/entry units
   v   verify the partition table
   w   write table to disk and exit
   x   extra functionality (experts only)

命令(输入 m 获取帮助)：n
Partition type:
   p   primary (0 primary, 0 extended, 4 free)
   e   extended
Select (default p): p
分区号 (1-4，默认 1)：
起始 扇区 (2048-629145599，默认为 2048)：
将使用默认值 2048
Last 扇区, +扇区 or +size{K,M,G} (2048-629145599，默认为 629145599)：
将使用默认值 629145599
分区 1 已设置为 Linux 类型，大小设为 300 GiB

命令(输入 m 获取帮助)：w
The partition table has been altered!

Calling ioctl() to re-read partition table.
正在同步磁盘。
[root@localhost ~]# mkdir /data
[root@localhost ~]# mkfs.ext4 /dev/sdb
mke2fs 1.42.9 (28-Dec-2013)
/dev/sdb is entire device, not just one partition!
无论如何也要继续? (y,n) y
文件系统标签=
OS type: Linux
块大小=4096 (log=2)
分块大小=4096 (log=2)
Stride=0 blocks, Stripe width=0 blocks
19660800 inodes, 78643200 blocks
3932160 blocks (5.00%) reserved for the super user
第一个数据块=0
Maximum filesystem blocks=2227175424
2400 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks: 
	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 
	4096000, 7962624, 11239424, 20480000, 23887872, 71663616

Allocating group tables: 完成                            
正在写入inode表: 完成                            
Creating journal (32768 blocks): 完成
Writing superblocks and filesystem accounting information: 完成     

[root@localhost ~]# mount /dev/sdb /data
[root@localhost ~]# echo '/dev/sdb /data ext4 defaults 0 0' >> /etc/fstab
[root@localhost ~]# cat /etc/fstab

#
# /etc/fstab
# Created by anaconda on Fri Feb  3 16:02:08 2023
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
UUID=191f6880-2681-48da-b0f1-8cb4daf50fc6 /                       xfs     defaults        0 0
UUID=b904f427-9d5f-4815-97c6-bb279e6ef7b5 /boot                   ext4    defaults        1 2
UUID=d3713011-e760-482f-a157-7d6b6085003f swap                    swap    defaults        0 0
/dev/sdb /data ext4 defaults 0 0
[root@localhost ~]# 
[root@localhost ~]# reboot
```





# Nginx



- 安装nginx

  yum install nginx

- 启动nginx

  systemctl start nginx.service

- 设置开机自启动

  systemctl enable nginx.service

- 修改配置文件

  ```shell
  [root@node3 laiting]# cd /etc/nginx/conf.d
  [root@node3 laiting]# vim xxxx.conf
  server {
          listen 443 ssl;   #SSL协议访问端口号为443。此处如未添加ssl，可能会造成Nginx无法启动。
          server_name www.xxx.com;  #将localhost修改为您证书绑定的域名，例如：www.example.com。
           #设置上传文件的大小
          client_max_body_size 800M;
          proxy_set_header Cookie $http_cookie; 
          proxy_set_header X-Forwarded-Host $host; 
          proxy_set_header X-Real-IP $remote_addr; 
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
  
          #请求头总长度大于128k时使用large_client_header_buffers设置的缓存区 
          client_header_buffer_size 128k;
  
          #指令参数4为个数，128k为大小，默认是8k。申请4个128k。
          large_client_header_buffers 4 128k;
  
          index index.html index.htm;
          ssl_certificate /xxx/xxx.com.pem;   #将domain name.pem替换成您证书的文件名。      
          ssl_certificate_key /xxx/xxx.com.key;   #将domain name.key替换成您证书的密钥文件名。      
          ssl_session_timeout 5m;
          ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;  #使用此加密套件。
          ssl_protocols TLSv1 TLSv1.1 TLSv1.2;   #使用该协议进行配置。
          ssl_prefer_server_ciphers on;
  
          # 前端主项目伪静态
          
          location / {
                  root /data/website/smart_parking_web;
                  try_files $uri $uri/ @router;
                  index index.html;
          }
          location @router {
                  rewrite ^.*$ /index.html last;
          } 
             # 前端大屏项目伪静态
          location ^~ /DataV {
                  root /data/website;   #站点目录。
                  index index.html;
  								try_files $uri $uri/ /DataV/index.html;
          }
          # api
          location /api/ {
                  add_header Access-Control-Allow-Origin $http_origin; 
                  add_header Access-Control-Allow-Headers *;
  
                  proxy_set_header X-real-ip $remote_addr;
                  proxy_pass http://127.0.0.1:30000/api/;
  								proxy_set_header Host $http_host;
  								proxy_set_header X-Real-IP $remote_addr;
  								proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  								proxy_set_header X-Forwarded-Proto $scheme;
          }
        
          # Start 报表接口配置 
          location /Report/ { 
                  proxy_pass http://127.0.0.1:8200/; 
          }
  				
  				#报表微服务接口
  				location /ReportServer/ { 
                  proxy_pass http://127.0.0.1:30007/; 
          }
  
          # 文件预览（smart-file-preview） 
          location /FileServer { 
                  proxy_pass http://127.0.0.1:30090; 
          }
          location ~ /FileServer/*.*\.(js|css)?$ { 
                  proxy_pass http://127.0.0.1:30090; 
          } 
          # End 报表接口配置
  
  	 		#智慧停车nacos
  			location /nacos/ {
          	proxy_set_header X-real-ip remote_addr;
          	proxy_pass http://127.0.0.1:30099;
      	}
      
      	#智慧停车nacos
      	location /seate/ {
          	proxy_set_header X-real-ip remote_addr;
          	proxy_pass http://127.0.0.1:30098;
      	}
      	#swagger-ui网关映射
      	location /swagger/ {
  					proxy_pass http://127.0.0.1:30000/;
  			}
      }
  ```

  

  



# JDK

- JDK 安装版本1.8.0_345 

  

> yum install java

```shell
[root@node3 laiting]# yum install java
Last metadata expiration check: 2:57:38 ago on Mon 31 Oct 2022 06:25:02 AM CST.
Package java-1.8.0-openjdk-1:1.8.0.345.b01-1.al8.x86_64 is already installed.
Dependencies resolved.
===================================================================================================================================================================================================
 Package                                                 Architecture                       Version                                              Repository                                   Size
===================================================================================================================================================================================================
Upgrading:
 java-1.8.0-openjdk                                      x86_64                             1:1.8.0.352.b08-2.al8                                alinux3-updates                             350 k
 java-1.8.0-openjdk-headless                             x86_64                             1:1.8.0.352.b08-2.al8                                alinux3-updates                              34 M
 tzdata-java                                             noarch                             2022e-1.1.al8                                        alinux3-updates                             186 k

Transaction Summary
===================================================================================================================================================================================================
Upgrade  3 Packages

Total download size: 35 M
Is this ok [y/N]: y
Downloading Packages:
(1/3): tzdata-java-2022e-1.1.al8.noarch.rpm                                                                                                                         10 MB/s | 186 kB     00:00    
(2/3): java-1.8.0-openjdk-1.8.0.352.b08-2.al8.x86_64.rpm                                                                                                            13 MB/s | 350 kB     00:00    
(3/3): java-1.8.0-openjdk-headless-1.8.0.352.b08-2.al8.x86_64.rpm                                                                                                   95 MB/s |  34 MB     00:00    
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Total                                                                                                                                                               96 MB/s |  35 MB     00:00     
Running transaction check
Transaction check succeeded.
Running transaction test
Transaction test succeeded.
Running transaction
  Running scriptlet: java-1.8.0-openjdk-headless-1:1.8.0.352.b08-2.al8.x86_64                                                                                                                  1/1 
  Preparing        :                                                                                                                                                                           1/1 
  Upgrading        : tzdata-java-2022e-1.1.al8.noarch                                                                                                                                          1/6 
  Upgrading        : java-1.8.0-openjdk-headless-1:1.8.0.352.b08-2.al8.x86_64                                                                                                                  2/6 
warning: /etc/java/java-1.8.0-openjdk/java-1.8.0-openjdk-1.8.0.352.b08-2.al8.x86_64/lib/security/java.policy created as /etc/java/java-1.8.0-openjdk/java-1.8.0-openjdk-1.8.0.352.b08-2.al8.x86_64/lib/security/java.policy.rpmnew

  Running scriptlet: java-1.8.0-openjdk-headless-1:1.8.0.352.b08-2.al8.x86_64                                                                                                                  2/6 
restored /etc/java/java-1.8.0-openjdk/java-1.8.0-openjdk-1.8.0.352.b08-2.al8.x86_64/lib/security/java.policy.rpmnew to /etc/java/java-1.8.0-openjdk/java-1.8.0-openjdk-1.8.0.352.b08-2.al8.x86_64/lib/security/java.policy

  Upgrading        : java-1.8.0-openjdk-1:1.8.0.352.b08-2.al8.x86_64                                                                                                                           3/6 
  Running scriptlet: java-1.8.0-openjdk-1:1.8.0.352.b08-2.al8.x86_64                                                                                                                           3/6 
  Cleanup          : java-1.8.0-openjdk-1:1.8.0.345.b01-1.al8.x86_64                                                                                                                           4/6 
  Running scriptlet: java-1.8.0-openjdk-1:1.8.0.345.b01-1.al8.x86_64                                                                                                                           4/6 
  Cleanup          : java-1.8.0-openjdk-headless-1:1.8.0.345.b01-1.al8.x86_64                                                                                                                  5/6 
  Running scriptlet: java-1.8.0-openjdk-headless-1:1.8.0.345.b01-1.al8.x86_64                                                                                                                  5/6 
  Cleanup          : tzdata-java-2022c-1.al8.noarch                                                                                                                                            6/6 
  Running scriptlet: java-1.8.0-openjdk-headless-1:1.8.0.352.b08-2.al8.x86_64                                                                                                                  6/6 
  Running scriptlet: java-1.8.0-openjdk-1:1.8.0.352.b08-2.al8.x86_64                                                                                                                           6/6 
  Running scriptlet: tzdata-java-2022c-1.al8.noarch                                                                                                                                            6/6 
  Verifying        : java-1.8.0-openjdk-1:1.8.0.352.b08-2.al8.x86_64                                                                                                                           1/6 
  Verifying        : java-1.8.0-openjdk-1:1.8.0.345.b01-1.al8.x86_64                                                                                                                           2/6 
  Verifying        : java-1.8.0-openjdk-headless-1:1.8.0.352.b08-2.al8.x86_64                                                                                                                  3/6 
  Verifying        : java-1.8.0-openjdk-headless-1:1.8.0.345.b01-1.al8.x86_64                                                                                                                  4/6 
  Verifying        : tzdata-java-2022e-1.1.al8.noarch                                                                                                                                          5/6 
  Verifying        : tzdata-java-2022c-1.al8.noarch                                                                                                                                            6/6 

Upgraded:
  java-1.8.0-openjdk-1:1.8.0.352.b08-2.al8.x86_64                   java-1.8.0-openjdk-headless-1:1.8.0.352.b08-2.al8.x86_64                   tzdata-java-2022e-1.1.al8.noarch                  

Complete!

```

```shell
java -version
openjdk version "1.8.0_345"
OpenJDK Runtime Environment (build 1.8.0_345-b01)
OpenJDK 64-Bit Server VM (build 25.345-b01, mixed mode)
```

注意：节点启动nocas报错JAVA_HOME的错的情况下，安装一下javac就好了

# MySql

## 安装方式一：下载编译安装

```
[root@swzhtc laiting]# cd /data/
```

- 下载mysql-5.7.38-linux-glibc2.12-x86_64.tar.gz

```
[root@swzhtc data]# wget https://downloads.mysql.com/archives/get/p/23/file/mysql-5.7.38-linux-glibc2.12-x86_64.tar.gz
--2022-10-31 09:30:48--  https://downloads.mysql.com/archives/get/p/23/file/mysql-5.7.38-linux-glibc2.12-x86_64.tar.gz
Resolving downloads.mysql.com (downloads.mysql.com)... 69.192.12.46, 2600:1417:e800:189::2e31, 2600:1417:e800:18a::2e31
Connecting to downloads.mysql.com (downloads.mysql.com)|69.192.12.46|:443... connected.
HTTP request sent, awaiting response... 302 Moved Temporarily
Location: https://cdn.mysql.com/archives/mysql-5.7/mysql-5.7.38-linux-glibc2.12-x86_64.tar.gz [following]
--2022-10-31 09:30:48--  https://cdn.mysql.com/archives/mysql-5.7/mysql-5.7.38-linux-glibc2.12-x86_64.tar.gz
Resolving cdn.mysql.com (cdn.mysql.com)... 173.222.228.218
Connecting to cdn.mysql.com (cdn.mysql.com)|173.222.228.218|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 674830866 (644M) [application/x-tar-gz]
Saving to: ‘mysql-5.7.38-linux-glibc2.12-x86_64.tar.gz’

mysql-5.7.38-linux-glibc2.12-x86_64.tar.gz       100%[=========================================================================================================>] 643.57M  18.1MB/s    in 57s     

2022-10-31 09:31:46 (11.4 MB/s) - ‘mysql-5.7.38-linux-glibc2.12-x86_64.tar.gz’ saved [674830866/674830866]
```

- 解压安装包

```
[root@swzhtc data]# tar -zxvf mysql-5.7.38-linux-glibc2.12-x86_64.tar.gz
```

- 重名名为mysql

```
[root@swzhtc data]# mv mysql-5.7.38-linux-glibc2.12-x86_64 mysql
```

- 将mysql 拷贝到/usr/local/位置下

```
[root@swzhtc data]# cp -R mysql /usr/local/
[root@swzhtc data]# cd /usr/local/mysql/
```

- 添加mysql用户组并授权权限

```
[root@swzhtc data]# groupadd mysql
[root@swzhtc data]# useradd -r -g mysql mysql
[root@swzhtc data]# chown mysql:mysql -R /data/mysql
```

- 创建my.conf文件

```
[root@swzhtc data]# vim /etc/my.cnf
```

- 查看my.conf配置文件

```
[root@swzhtc bin]# cat /etc/my.cnf 
```

```
[client]
socket=/tmp/mysql.sock
default-character-set=utf8mb4

[mysql]
default-character-set=utf8mb4

[mysqld]

# Remove leading # and set to the amount of RAM for the most important data
# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.
# innodb_buffer_pool_size = 128M
#
# Remove leading # to turn on a very important data integrity option: logging
# changes to the binary log between backups.
# log_bin
#
# Remove leading # to set options mainly useful for reporting servers.
# The server defaults are faster for transactions and fast SELECTs.
# Adjust sizes as needed, experiment to find the optimal values.
# join_buffer_size = 128M
# sort_buffer_size = 2M
# read_rnd_buffer_size = 2M
#datadir=/var/lib/mysql
#socket=/var/lib/mysql/mysql.sock
#修改后
basedir=/usr/local/mysql #yum自动安装的需要添加这个配置
datadir=/data/mysql
socket=/tmp/mysql.sock
pid-file=/data/mysql/mysql.pid
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci
init_connect='SET NAMES utf8mb4'
sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION
#

slow_query_log=1 #开启慢日志
slow_query_log_file=/data/mysql/logs/slow_query_log.txt
#查询超过10秒就记录
long_query_time=5 #查询超过十秒就记录

# Disabling symbolic-links is recommended to prevent assorted security risks
symbolic-links=0

#binlog配置
log-bin=mysql-bin # 开启 binlog
binlog-format=ROW # 选择 ROW 模式
server_id=1 # 配置 MySQL

log-error=/data/mysql/mysql.err
pid-file=/data/mysql/mysql.pid

explicit_defaults_for_timestamp=1
```

- 授权配置文件

```
[root@swzhtc data]# chmod 644 /etc/my.cnf
```

- 创建Mysql数据存放目录

```
[root@swzhtc data]# mkdir -p  /data/mysql
```

- 执行安装

```
[root@swzhtc laiting]# cd /usr/local/mysql/bin/
```

```
./mysqld --defaults-file=/etc/my.cnf --basedir=/usr/local/mysql/ --datadir=/data/mysql/ --user=mysql --initialize
```

> > 安装错误：
> >
> > [root@swzhtc bin]# ./mysqld --defaults-file=/etc/my.cnf --basedir=/usr/local/mysql/ --datadir=/data/mysql/ --user=mysql --initialize
> > ./mysqld: error while loading shared libraries: libaio.so.1: cannot open shared object file: No such file or directory
>
> 解决办法：**yum install -y libaio**

```
[root@swzhtc bin]# ./mysqld --defaults-file=/etc/my.cnf --basedir=/usr/local/mysql/ --datadir=/data/mysql/ --user=mysql --initialize
./mysqld: error while loading shared libraries: libaio.so.1: cannot open shared object file: No such file or directory
[root@swzhtc bin]# yum install -y libaio
Last metadata expiration check: 0:53:09 ago on Mon 31 Oct 2022 08:50:23 AM CST.
Dependencies resolved.
===================================================================================================================================================================================================
 Package                                    Architecture                               Version                                                Repository                                      Size
===================================================================================================================================================================================================
Installing:
 libaio                                     x86_64                                     0.3.112-1.2.al8                                        alinux3-os                                      33 k

Transaction Summary
===================================================================================================================================================================================================
Install  1 Package

Total download size: 33 k
Installed size: 103 k
Downloading Packages:
libaio-0.3.112-1.2.al8.x86_64.rpm                                                                                                                                  967 kB/s |  33 kB     00:00    
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Total                                                                                                                                                              948 kB/s |  33 kB     00:00     
Running transaction check
Transaction check succeeded.
Running transaction test
Transaction test succeeded.
Running transaction
  Preparing        :                                                                                                                                                                           1/1 
  Installing       : libaio-0.3.112-1.2.al8.x86_64                                                                                                                                             1/1 
  Running scriptlet: libaio-0.3.112-1.2.al8.x86_64                                                                                                                                             1/1 
  Verifying        : libaio-0.3.112-1.2.al8.x86_64                                                                                                                                             1/1 

Installed:
  libaio-0.3.112-1.2.al8.x86_64                                                                                                                                                                    

Complete!

```

- 安装成功后，查询临时密码，在最后一行： A temporary password is generated for root@localhost: **ivdaFY;,1Cl**

```
[root@swzhtc bin]# cat /data/mysql/mysql.err
2022-10-31T02:16:56.548385Z 0 [Warning] 'NO_AUTO_CREATE_USER' sql mode was not set.
2022-10-31T02:16:56.768522Z 0 [Warning] InnoDB: New log files created, LSN=45790
2022-10-31T02:16:56.802557Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.
mysqld: File '/data/mysql/logs/slow_query_log.txt' not found (Errcode: 2 - No such file or directory)
2022-10-31T02:16:56.857618Z 0 [ERROR] Could not use /data/mysql/logs/slow_query_log.txt for logging (error 2 - No such file or directory). Turning logging off for the server process. To turn it on again: fix the cause, then either restart the query logging by using "SET GLOBAL SLOW_QUERY_LOG=ON" or restart the MySQL server.
2022-10-31T02:16:56.860358Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: 180aa393-58c2-11ed-8cf9-00163e0ab541.
2022-10-31T02:16:56.861047Z 0 [Warning] Gtid table is not ready to be used. Table 'mysql.gtid_executed' cannot be opened.
2022-10-31T02:16:56.979316Z 0 [Warning] A deprecated TLS version TLSv1 is enabled. Please use TLSv1.2 or higher.
2022-10-31T02:16:56.979326Z 0 [Warning] A deprecated TLS version TLSv1.1 is enabled. Please use TLSv1.2 or higher.
2022-10-31T02:16:56.979650Z 0 [Warning] CA certificate ca.pem is self signed.
2022-10-31T02:16:57.054539Z 1 [Note] A temporary password is generated for root@localhost: ivdaFY;,1Clt

```

- 先将mysql.server移动到/etc/init.d/mysql中

```
cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysql
```

- 然后启动mysql，并查看mysql状态

```
#启动mysql
service mysql start
#查看mysql运行状态
service mysql status
ps -ef|grep mysql
```

> 由于当前并没有全局设置mysql命令，所以先切换到/usr/local/mysql/bin/文件夹下

```
[root@swzhtc bin]# cd /usr/local/mysql/bin/
```

> 登陆MySql
>
> [root@swzhtc bin]# ./mysql -uroot -p**PASSWORD** 
>
>  **请将PASSWORD替换成临时密码**，或者直接执行：./mysql -uroot -p 在提示Enter password:后将临时密码粘贴，回车即可~



- 然后再执行下面的操作设置密码(Ltkj@2022@mysql)

```
SET PASSWORD = PASSWORD('newPassword');
ALTER USER 'root'@'localhost' PASSWORD EXPIRE NEVER;
FLUSH PRIVILEGES;       
use mysql;
```

使root用户可以在任何IP访问

```
update user set host = '%' where user = 'root';
```

刷新

```
FLUSH PRIVILEGES;
```

建立软连接

```
ln -s /usr/local/mysql/bin/mysql /usr/bin/
```

设置mysql开机启动

设置mysql开机自启动

```
chkconfig mysql on
```

取消mysql开机自启动

```
chkconfig mysql off
```

查看系统服务列表，以及每个服务的运行级别

```
chkconfig --list
```

或

```
systemctl list-unit-file
```

- 添加canal用户(EScanal 使用)

  ```XHSELL
  [root]# mysql -u账号 -p密码
  --添加一个账号名为'canal'，密码为'canal_666'的账号，并授权 
  > CREATE USER canal IDENTIFIED BY 'canal_666';
  > GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'canal'@'%';
  > FLUSH PRIVILEGES;
  ```

- 如果添加后启动canal包错，使用用户名和密码登录一下mysql，不行就直接更新密码重新使用

  ```xshell
  UPDATE mysql.user SET authentication_string=PASSWORD('新密码') WHERE User='用户名';
  ```

> 操作记录如下:

```

[root@swzhtc bin]# ./mysql -uroot -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 4
Server version: 5.7.38-log

Copyright (c) 2000, 2022, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> 
mysql> SET PASSWORD = PASSWORD('newPassword');
Query OK, 0 rows affected, 1 warning (0.00 sec)


mysql> ALTER USER 'root'@'localhost' PASSWORD EXPIRE NEVER;
Query OK, 0 rows affected (0.00 sec)

mysql> FLUSH PRIVILEGES;       
Query OK, 0 rows affected (0.00 sec)

mysql> use mysql;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> update user set host = '%' where user = 'root';
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql> FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.00 sec)

mysql> exit
Bye

```

> - **linux下mysql怎么修改端口号**
>
> - 编辑 **vim /etc/my.cnf** 文件，找到mysql配置文件my.cnf的port这一行，把之前的3306端口修改为自己想要的就行
>
> ```
> vim /etc/my.cnf
> ```
>
> 
>
> ```
> [mysqld]
> port=13306
> ```
>
> 修改完成后执行：**service mysql restart**
>
> ```
> service mysql restart
> ```

linux下mysql开启远程访问并开启3306端口

> **一、登陆mysql**
>
> ```
> mysql -u root -p
> ```
>
> **二、设置访问地址**
>
> ```
> 如果你想允许用户root从ip为192.168.1.123的主机连接到mysql服务器，并使用root作为密码   
> GRANT ALL PRIVILEGES ON *.* TO 'root'@'192.168.1.123'IDENTIFIED BY 'password' WITH GRANT OPTION;   
> ```
>
> **三、刷新**
>
> ```
> flush privileges;
> ```
>
> **防火墙开启**
>
> **四、开启端口3306**
>
> ```
> firewall-cmd --zone=public --add-port=13306/tcp --permanent
> ```
>
> **五、重启防火墙**
>
> ```
> firewall-cmd --reload
> ```
>
> **六、查看已经开放的端口**
>
> ```
> firewall-cmd --list-ports
> ```



# Redis

## linux 下安装redis并设置开机自启动

## 一. 下载并解压

### 1. 执行命令：

```
wget https://download.redis.io/releases/redis-6.2.6.tar.gz
```

### 2.解压redis：

```
tar xzf redis-6.2.6.tar.gz
```

### 3. 修改目录

```
mv redis-6.2.6 /usr/local/redis
```

## 二. 编译

- 进入redis安装目录，执行make命令编译redis

```
cd /usr/local/redis

make
```

错误解决：

如果执行make命令报错：cc 未找到命令，原因是虚拟机系统中缺少gcc，执行下面命令安装gcc

```
yum -y install gcc automake autoconf libtool make
```

如果执行make命令报错：致命错误:jemalloc/jemalloc.h: 没有那个文件或目录，则需要在make指定分配器为libc。执行下面命令即可正常编译：

```
make MALLOC=libc
```

- 执行下面命令安装redis，并指定安装目录

```
make install PREFIX=/usr/local/redis
```

- 启动redis
- 启动命令：

```
./bin/redis-server redis.conf
```

### 配置redis



>  详细指令参考：

```
[root@swzhtc redis]# pwd
/usr/local/redis
[root@swzhtc redis]# mkdir /etc/redis
[root@swzhtc redis]# cp -r redis.conf /etc/redis/6379.conf
[root@swzhtc redis]# cp utils/redis_init_script /etc/init.d/redis
[root@swzhtc redis]# vim /etc/redis/6379.conf

```

> 6379.conf配置文件修改相关参数

```
vim /etc/redis/6379.conf
```

- **1、修改配置文件支持后台启动**

- 打开redis.conf 将daemonize no改为daemonize yes即可

```
daemonize yes
```

- **2、支持远程连接**

- bind 127.0.0.1 -::1注释掉

```
bind 127.0.0.1 -::1
```

- 把protected-mode yes改为protected-mode no即可

```
protected-mode no
```

- **3、设置redis连接密码**

修改redis.conf配置文件

```
# requirepass foobared
requirepass 123   指定密码123
```

- 保存后重启redis就可以了

- redis-cli连接redis

```
[root@iZ2ze3zda3caeyx6pn7c5zZ bin]# cd /usr/local/redis/bin/
[root@iZ2ze3zda3caeyx6pn7c5zZ bin]# ./redis-cli
127.0.0.1:6379> keys *
(error) NOAUTH Authentication required.
127.0.0.1:6379> auth 123        //指定密码
OK
127.0.0.1:6379> keys *
1) "a"
2) "cit"
3) "clist"
4) "1"
127.0.0.1:6379>
```

- 设置开机自启动

- 复制配置文件 redis.conf /etc/redis/ ，改名6379.conf

```
cp -r redis.conf /etc/redis/6379.conf
```

-  复制配置文件

```
cp utils/redis_init_script /etc/init.d/redis
```



- 修改文件位置以下两行，修改为自己实际安装位置

> EXEC=/usr/local/redis/bin/redis-server
> CLIEXEC=/usr/local/redis/bin/redis-cli

```
#!/bin/sh
# 
# Simple Redis init.d script conceived to work on Linux systems
# as it does use of the /proc filesystem.

### BEGIN INIT INFO
# Provides:     redis_6379
# Default-Start:        2 3 4 5
# Default-Stop:         0 1 6
# Short-Description:    Redis data structure server
# Description:          Redis data structure server. See https://redis.io
### END INIT INFO

REDISPORT=6379
EXEC=/usr/local/redis/bin/redis-server
CLIEXEC=/usr/local/redis/bin/redis-cli

PIDFILE=/var/run/redis_${REDISPORT}.pid
CONF="/etc/redis/${REDISPORT}.conf"

case "$1" in
    start)
        if [ -f $PIDFILE ]
        then
                echo "$PIDFILE exists, process is already running or crashed"
        else
                echo "Starting Redis server..."
                $EXEC $CONF
        fi
        ;;
    stop)
        if [ ! -f $PIDFILE ]
        then
                echo "$PIDFILE does not exist, process is not running"
        else
                PID=$(cat $PIDFILE)
                echo "Stopping ..."
                $CLIEXEC -p $REDISPORT shutdown
                while [ -x /proc/${PID} ]
                do
                    echo "Waiting for Redis to shutdown ..."
                    sleep 1
                done
                echo "Redis stopped"
        fi
        ;;
    *)
        echo "Please use start or stop as first argument"
        ;;
esac
```

- 修改文件权限

```
chmod 777 /etc/init.d/redis
```

- 设为开机启动

```
chkconfig redis on
```

-  启动/停止服务

```
   service redis start

   service redis stop
```

> 或者用如下指令启动或查看启动状态

```
[root@swzhtc redis]# systemctl restart redis
[root@swzhtc redis]# systemctl status redis
● redis.service - LSB: Redis data structure server
   Loaded: loaded (/etc/rc.d/init.d/redis; generated)
   Active: active (running) since Mon 2022-10-31 11:30:36 CST; 7s ago
     Docs: man:systemd-sysv-generator(8)
  Process: 63920 ExecStart=/etc/rc.d/init.d/redis start (code=exited, status=0/SUCCESS)
    Tasks: 4 (limit: 200229)
   Memory: 1.0M
   CGroup: /system.slice/redis.service
           └─63922 /usr/local/redis/bin/redis-server 127.0.0.1:6379

Oct 31 11:30:36 swzhtc systemd[1]: Starting LSB: Redis data structure server...
Oct 31 11:30:36 swzhtc redis[63920]: Starting Redis server...
Oct 31 11:30:36 swzhtc systemd[1]: Started LSB: Redis data structure server.

```



# RabbitMQ

## 教程一

老版本，没有延迟队列，建议按照教程二

安装流程：

- 进入root文件夹下面, 新建文件夹名为mq

```
[root]# cd /data 
[root]# mkdir mq root]# cd mq
```



- 准备环境： 

```
[root]# yum -y install make gcc gcc-c++ kernel-devel m4 ncurses-devel openssl-devel
```

- 源码下载

```shell
wget https://github.com/erlang/otp/releases/download/OTP-21.3/otp_src_21.3.tar.gz
```

- 将'otp_src_21.3.tar.gz'安装包拖入到mq文件夹下面, 并解压

```shell
[root]# tar xzf otp_src_21.3.tar.gz
```

- 进入目录：

```shell
[root]# cd otp_src_21.3
```

- 设定安装规则：

```shell
[root]# ./configure --prefix=/data/mq/erlang --with-ssl --enable-threads --enable-smp-support --enable-kernel-poll --enable-hipe --without-javac
```

- 安装：

```shell
make && make install
```

- 此过程有点久。大概3分钟。。

- 编辑配置文件

```shell
[root]# vim /etc/profile
```

- 在末尾加入以下内容：

```shell
#set erlang environment
ERL_PATH=/data/mq/erlang/bin
PATH=$ERL_PATH:$PATH
[root]# source /etc/profile
```

使环境变量立即生效 最后输入*erl* ,验证是否安装成功（出现erlang版本号即成功）

 <font color='red'> 注意：erlang 版本和rabbitMQ 的版本要对应匹配</font>

安装rabbitMQ 下载rabbitmq-server安装包（安装3.8以上版本）

https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.8.13

在/data/mq/文件架下面新建rabbitmq文件夹 把rabbitmq-server-generic-unix-3.8.13.tar.xz放到该目录下面, 并解压

```shell
wget https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.8.13/rabbitmq-server-generic-unix-3.8.13.tar.xz

[root]# tar xvf rabbitmq-server-generic-unix-3.8.13.tar.xz
```

改名

```shell
[root]# mv rabbitmq_server-3.8.13/ rabbitmq/
```

设置环境变量

```shell
[root]#  vim /etc/profile
```

在末尾加入以下内容：

```shell
#set RabbitMQ environment
MQ_PATH=/data/mq/rabbitmq/sbin
PATH=$MQ_PATH:$PATH

[root]# source /etc/profile	使环境变量立即生效
```

进入到rabbimq/sbin目录下。 后台启动rabbitmq：

```shell
[root]#  ./rabbitmq-server -detached
```

通过查看服务状态

```shell
[root]#  service rabbitmq-server status
```

开启管理界面

```shell
[root]#  ./rabbitmq-plugins  list
[root]#  ./rabbitmq-plugins enable rabbitmq_management
[root]#  ./rabbitmqctl add_user rabbitmq rabbitmq
[root]#  ./rabbitmqctl set_user_tags rabbitmq administrator
```

-------重要-------

创建用户,您将需要为RabbitMQ Web管理控制台创建管理用户。 运行以下命令相同

```shell
./rabbitmqctl add_user admin StrongPassword
./rabbitmqctl set_user_tags admin administrator
./rabbitmqctl set_permissions -p / admin “.*” “.*” “.*”
```

将管理员更改为管理员用户的首选用户名。 确保将StrongPassword更改为非常强大的密码

firewall-cmd --zone=public --add-port=15672/tcp --permanent firewall-cmd --zone=public --add-port=5672/tcp --permanent firewall-cmd --reload

服务器需要开启15672端口与5672端口访问 访问web端： http://ip:15672



## 教程二

### 手工部署RabbitMQ（CentOS 7.4）

#### 简介

本文介绍了如何在华为云上使用弹性云服务器的Linux实例部署RabbitMQ。RabbitMQ是采用Erlang语言实现AMQP（Advanced Message Queuing Protocol，高级消息队列协议）的消息中间件，它最初起源于金融系统，用于在分布式系统中存储转发消息。RabbitMQ凭借其高可靠、易扩展、高可用及丰富的功能特性成为目前非常热门的一款消息中间件。

#### 前提条件

弹性云服务器所在安全组添加了如下表所示的安全组规则，具体步骤参见[为安全组添加安全组规则]。

| 方向   | 类型 | 协议 | 端口/范围 | 源地址    |
| ------ | ---- | ---- | --------- | --------- |
| 入方向 | IPv4 | TCP  | 5672      | 0.0.0.0/0 |
| 入方向 | IPv4 | TCP  | 15672     | 0.0.0.0/0 |

#### 操作步骤

1. 安装相关依赖包和perl。

   

   1. 登录弹性云服务器。

   2. 执行以下命令，安装相关依赖包。

      **yum** **-y install make gcc gcc-c++ m4 ncurses-devel openssl-devel unixODBC-devel**

   3. 执行如下命令，安装perl。

      **yum install perl**

   

2. 安装erlang。

   

   关于erlang的安装请参考[Erlang官方资料](https://www.erlang-solutions.com/downloads/)。

   > 方式一（推荐）

   1. 官方下载最新的rpm文件

   ![image-20230314162208050](http://cdn.yuncitys.com/202303141622188.png)

   2. 下载后把文件上传到服务器

   3. 执行安装

      ```xshel
      [root@ecs-rabbitmq ~]# yum -y install esl-erlang_25.0.3-1_centos_7_amd64.rpm
      [root@ecs-rabbitmq ~]# erl -version
      Erlang (SMP,ASYNC_THREADS,HIPE) (BEAM) emulator version 13.*.*
      ```

   > 方式二（不推荐）

   1. 添加erlang存储库到系统

      **wget https://packages.erlang-solutions.com/erlang-solutions-2.0-1.noarch.rpm**

      **rpm -Uvh erlang-solutions-2.0-1.noarch.rpm**

      或手动添加存储库条目

      **rpm --import https://packages.erlang-solutions.com/rpm/erlang_solutions.asc**

   2. 在/etc/yum.repos.d/目录下新建一个文件rabbitmq-erlang.repo，然后将下面的粘帖进去

      **cd /etc/yum.repos.d/**

      **vi rabbitmq-erlang.repo**

      ```
      [erlang-solutions]
      name=CentOS $releasever - $basearch - Erlang Solutions
      baseurl=https://packages.erlang-solutions.com/rpm/centos/$releasever/$basearch
      gpgcheck=1
      gpgkey=https://packages.erlang-solutions.com/rpm/erlang_solutions.asc
      enabled=1
      ```

      

      按**Esc**键退出编辑模式，并输入**:wq**保存后退出。

   3. 执行以下命令安装erlang

      **sudo yum install erlang**

      执行以下命令安装esl-erlang

      **sudo yum install esl-erlang**

   4. 执行如下命令，检查安装结果。

      **erl -version**

      回显类似如下信息，说明erlang安装成功。

      ```
      [root@ecs-rabbitmq ~]# erl -version
      Erlang (SMP,ASYNC_THREADS,HIPE) (BEAM) emulator version 11.1.7
      ```

      

   

3. 安装RabbitMQ

   

   1. 执行如下命令，进入用户主目录。

      **cd**

   2. 执行如下命令，下载RabbitMQ安装包。

      1. 打开[Rabbit官网](https://www.rabbitmq.com/)。

      2. 点击“Get Started”。

         图1 Get Started
         ![点击放大](http://cdn.yuncitys.com/zh-cn_image_0000001080124774.png)

      3. 找到并单击“Download+Installation”。

         图2 Download+Installation
         ![点击放大](http://cdn.yuncitys.com/zh-cn_image_0000001127141107.png)

      4. 

         

         根据云服务器的操作系统选择下载地址。例如本例中使用的是CentOS 7.x的下载地址。

         图3 选择下载地址
         ![点击放大](http://cdn.yuncitys.com/zh-cn_image_0000001080124804.png)

      5. 在服务器上执行执行以下命名下载RabbitMQ安装包。建议下载最新版本

         例如[3.b.iv](https://support.huaweicloud.com/bestpractice-ecs/zh-cn_topic_0143982115.html#ZH-CN_TOPIC_0143982115__li32221020164213)查找的下载地址是：

         wget https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.11.10/rabbitmq-server-3.11.10-1.el8.noarch.rpm

         如果下载过程中提示“Unable to establish SSL connection.”

         可以在wget命令后加--no-check-certificate，重复执行几次，即可下载。

         例如：

         **wget https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.11.10/rabbitmq-server-3.11.10-1.el8.noarch.rpm --no-check-certificate**

      6. 执行以下命令安装RabbitMQ安装包。

         **yum install** **rabbitmq-server-3.8.12-1.el7.noarch.rpm**

      7. 安装延时插件

         > 下载rabbiimq延时插件

         插件地址：https://www.rabbitmq.com/community-plugins.html

         ![image-20230314160902303](http://cdn.yuncitys.com/202303141615094.png)

         ```xshell
         [root@ecs-rabbitmq ~]# cd /usr/lib/rabbitmq/lib/rabbitmq_server-3.11.10/plugins
         #文件上传到该目录下 
         ```

         ![image-20230314161603709](http://cdn.yuncitys.com/202303141616820.png)

         ```xshell
         [root@ecs-rabbitmq ~]# cd /usr/lib/rabbitmq/lib/rabbitmq_server-3.11.10/sbin
         #启用插件
         [root@ecs-rabbitmq ~]# ./rabbitmq-plugins enable rabbitmq_delayed_message_exchange
         ```

         参考：https://juejin.cn/post/6844904163168485383

   3. 安装完毕，启动RabbMQ

      **service rabbitmq-server start**

   4. 查看RabbMQ状态。

      **service rabbitmq-server status**

   

4. 执行如下命令，启用RabbitMQ的web管理界面。

   

   **rabbitmq-plugins enable rabbitmq_management**

   回显类似如下信息:

   ```
   [root@ecs-rabbitmq ~]# rabbitmq-plugins enable rabbitmq_management
   Enabling plugins on node rabbit@ecs-rabbitmq:
   rabbitmq_management
   The following plugins have been configured:
     rabbitmq_management
     rabbitmq_management_agent
     rabbitmq_web_dispatch
   Applying plugin configuration to rabbit@ecs-2b36...
   The following plugins have been enabled:
     rabbitmq_management
     rabbitmq_management_agent
     rabbitmq_web_dispatch
   
   started 3 plugins.
   ```

   

   

5. 执行如下命令，创建一个新用户。

   

   **rabbitmqctl add_user** *用户名 密码*

   命令示例：

   **rabbitmqctl add_user** **root 123456**

   

6. 执行如下命令，设置用户为管理员。

   

   **rabbitmqctl set_user_tags** *用户名* **administrator**

   命令示例：

   **rabbitmqctl set_user_tags root** **administrator**

   

7. 执行如下命令，赋予用户所有权限。

   

   **rabbitmqctl set_permissions -p /** *用户名* **'.\*' '.\*' '.\*'**

   命令示例：

   **rabbitmqctl set_permissions -p / root** **'.\*' '.\*' '.\*'**

   

8. 执行如下命令，在后台启动Rabbit

   

   **rabbitmq-server -detached**

   

9. 使用浏览器访问 “http://弹性公网IP:15672”，显示如下页面，说明RabbitMQ安装成功。

   

   ![img](http://cdn.yuncitys.com/zh-cn_image_0221472448.png)

   

10. 输入[步骤5]创建的用户名和密码后点击“Login”，进入RabbitMQ管理界面。

    

    ![点击放大](http://cdn.yuncitys.com/zh-cn_image_0221472449.png)



## 关键指令参考

```

  240  yum install erlang
  241  elr
  244  wget https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.7/rabbitmq-server-generic-unix-3.7.7.tar.xz
  245  tar xvf rabbitmq-server-generic-unix-3.7.7.tar.xz
  246  mv rabbitmq_server-3.7.7/ rabbitmq/
  247  vim /etc/profile
  249  ll
  250  cd rabbitmq/sbin/
  251  ll
  
  252  ./rabbitmq-server -detached
  253   service rabbitmq-server status
  
  254  pwd
  255  vim /etc/profile
  257   source /etc/profile
  
  264  rabbitmq-plugins enable rabbitmq_management
  
  266  rabbitmqctl add_user admin rabbitmq
  267  rabbitmqctl set_user_tags admin administrator
  268  rabbitmqctl set_permissions -p / admin  '.*' '.*' '.*'
  269  rabbitmq-server -detached
  270  ps afx|grep rabbit
  271
  273  rabbitmq-server -detached

```



# ElasticSearch



切换服务器目录 [root]# cd /usr/local

```
wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.6.2-linux-x86_64.tar.gz
tar -xzvf  elasticsearch-7.6.2-linux-x86_64.tar.gz
```

将elasticsearch-7.6.2.tar.gz放入local目录下 [root]# tar xzf elasticsearch-7.6.2.tar.gz

[root]# cd /usr/local/elasticsearch-7.6.2/config [root]# vim elasticsearch.yml 取消下面配置的注释，并修改为当前主机ip地址

```
cluster.name: my-application
node.name: node-1
network.host: 0.0.0.0	#获取填写本机ip
http.port: 9200
discovery.zen.ping.unicast.hosts: ["0.0.0.0"]
discovery.zen.minimum_master_nodes: 1 #注意，因为本人目前是单节点，这里必须为1
```

新增如下配置

```
transport.tcp.port: 9300
transport.tcp.compress: true
bootstrap.system_call_filter: false

http.cors.enabled: true
http.cors.allow-origin: "*"

indices.query.bool.max_clause_count: 1000000  #in查询参数最多1000000条
```

修改etc/sysctl.conf配置文件 [root]# vim /etc/sysctl.conf

```
#elasticsearch用户拥有的内存权限
vm.max_map_count=262144
```

执行命令使配置生效 [root]# sysctl -p

修改/etc/security/limits.conf配置文件, 在末尾添加配置 [root]# vim /etc/security/limits.conf

```shell
#每个进程最大同时打开文件数
* soft nofile 65536
* hard nofile 65536
* soft nproc  65536
* hard nproc  65536
```

重点：es 规定 root 用户不能启动 es，所以需要新建一个其他用户来修改es的配置文件, 并启动

```shell
[root]# adduser userEs
```

为用户solin设置密码, 输入两次相同的密码, 后期配置kibana要用到(我设置的密码是userEs666)

```shell
[root]# passwd userEs
添加权限
[root]# chown -R userEs /usr/local/elasticsearch-7.6.2
[root]# su userEs
```

准备启动

```shell
[userEs]# cd /usr/local/elasticsearch-7.6.2/bin
```

后台启动

```shell
[userEs]# ./elasticsearch -d
```

测试是否启动成功

```shell
[userEs]# curl -XGET http://127.0.0.1:9200
```

开启9200端口访问：

```shell
firewall-cmd --zone=public --add-port=9200/tcp --permanent
firewall-cmd --reload
```

查看端口：看到9100, 9200端口都已经启动

```shell
[userEs]# ss -tanl
```

一、设置密码(https://blog.csdn.net/weixin_43627706/article/details/125393511)

```
 ./elasticsearch-certutil ca
 # 提示设置密码直接回车就行
 cd ..
ls #这里在elasticsearch根目录已经可以看到 elastic-stack-ca.p12这个文件了

./elasticsearch-certutil cert --ca /usr/local/elasticsearch-7.6.2/elastic-stack-ca.p12
 # 提示设置密码直接回车就行
 
 # 进入/elasticsearch
cd /config
mkdir certs
cp /usr/local/elasticsearch-7.6.2/elastic-certificates.p12 certs #拷贝
```

1.需要在配置文件中开启x-pack验证, 修改config目录下面的elasticsearch.yml文件，在里面添加如下内容,并重启.

xpack.security.enabled: true xpack.license.self_generated.type: basic xpack.security.transport.ssl.enabled: true 2，执行设置用户名和密码的命令,这里需要为4个用户分别设置密码，elastic, kibana, logstash_system,beats_system

```
./elasticsearch-setup-passwords interactive # 在elasticsearch/bin目录下执行该命令，设置密码
```

213

parkingEs@userEs213

带密码查询

Elasticsearch设置用户名密码之后，不能再直接使用Elasticsearch head 访问，可以在查询等API上加上用户等参数：

curl -XGET --user user:passwd 'http://XXXX:9200/XX/XXX'

测试服 curl -XGET http://172.24.236.64:9200

穗腾 curl -XGET http://172.27.42.99:9200

修改es运行内存 [root]# export ES_HEAP_SIZE=2g

# Canal



## 多租户场景中canal多个数据源实例配置教程

### 1.前言

很多时候，我们很多业务场景可能只需要同步多个或者单个数据库多个或者单个表的数据，canal提供了多实例(Instance)功能让我们可以处理这些业务场景。

### 2.前期准备

| 服务名称  | IP/域名                                         | 端口 |
| --------- | ----------------------------------------------- | ---- |
| zookeeper | 192.168.142.129,192.168.142.130,192.168.142.131 | 2181 |
| mysql     | 192.168.142.131                                 | 3306 |
| rabbitmq  | 192.168.18.230                                  | 5672 |

#### 2.1RabbitMQ参数

**虚拟主机(Virtual hosts)：**Canal
**交换器(Exchanges)：**exchange.canal
**路由key(Routing key)：**routing.quote、routing.supplier
**队列(Queues)：**quote_example、supplier_example

### 3.两个实例(Instance)监听相同数据库

![img](http://cdn.yuncitys.com/420913-20220214172134905-1224506439.png)
先从conf目录下拷贝两份example实例，具体操作命令如下：

```
//供应商报价实例
cp -r /home/deng/canal/canal.deployer/conf/example /home/deng/canal/canal.deployer/conf/quote_example
//供应商实例
cp -r /home/deng/canal/canal.deployer/conf/example /home/deng/canal/canal.deployer/conf/supplier_example
```

如图所示：
![img](http://cdn.yuncitys.com/420913-20220214162725732-986940189.png)
客户端我们还是沿用上章节MQ（解析两个实例数据），这里不做代码如何解析数据了。
●修改canal.properties配置，把之前创建***supplier_example\***、***quote_example\***两个实例配置到**canal.destinations**选项去（如果配置集群，记得每个canal服务配置都要修改）：

```
vi conf/canal.properties
canal.destinations = quote_example,supplier_example
```

并找到RabbitMQ标题栏配置MQ配置：

[![复制代码](http://cdn.yuncitys.com/copycode.gif)](javascript:void(0);)

```
##################################################
#########             RabbitMQ         #############
##################################################
rabbitmq.host = 192.168.18.230 --MQ连接地址
rabbitmq.virtual.host = Canal --virtualHost
rabbitmq.exchange = exchange.canal --交换器名称
rabbitmq.username = admin --MQ登录用户名
rabbitmq.password = 123456 --MQ登录密码
rabbitmq.deliveryMode = 2 --投递模式，实现消息持久化：1.非持续性，2.持续性
```

[![复制代码](http://cdn.yuncitys.com/copycode.gif)](javascript:void(0);)

●两个实例(quote_example、supplier_example)instance.properties配置相同参数（不知道这几个参数是什么含义，可以翻看我之前写的文章或者查看官网）：

```
canal.instance.master.address=192.168.142.131:3306 --数据库连接地址
canal.instance.dbUsername=canal --数据库登录用户名
canal.instance.dbPassword=qwer1234 --数据库登录密码
```

●修改quote_example. instance.properties配置：

```
vi conf/quote_example/instance.properties
canal.mq.topic=routing.quote --MQ路由键
canal.instance.filter.regex=ebs_material.supplier_quote --数据解析关注的表（格式：数据库.表）
```

●修改supplier_example. instance.properties配置

```
vi conf/supplier_example/instance.properties
canal.mq.topic=routing.supplier --MQ路由键
canal.instance.filter.regex=ebs_material.supplier --数据解析关注的表（格式：数据库.表）
```

●清空rabbitmq消息，然后执行如下sql语句：

```
INSERT INTO ebs_material.supplier_quote (PN,Brand,StockQty,SupplierId,CreateTime) VALUES ('LM358DT','TI',10000,1,'2022-02-14 00:00:00');
INSERT INTO ebs_material.supplier (Name,CreateTime) VALUES ('艾睿','2022-02-14 00:00:00');
```

登录rabbitmq管理后台我们会看到只有两条待消费的消息（supplier_quote和supplier表插入行数据）：
![img](http://cdn.yuncitys.com/420913-20220214162805121-1851316699.png)

![img](http://cdn.yuncitys.com/420913-20220214162822628-1379881781.png)

![img](http://cdn.yuncitys.com/420913-20220214162833449-1960542154.png)

### 4.两个实例(Instance)监听不相同数据库

![img](http://cdn.yuncitys.com/420913-20220214172150904-83947082.png)
canal两个实例(Instance)监听不同数据库数据同步，其实也只是把每个实例连接数据库地址等配置修改下就可以了，其他配置跟上面小节基本一样的，想了解可以自行到官网查看，这里就不多说了，请大伙自行配置测试。

### 5. mysql数据解析关注的和Perl正则表达式

Canal为我们提供了canal.instance.filter.regex与canal.instance.filter.black.regex选项参数来过滤数据库表数据解析，类似黑白名单。常见例子有：
●所有表：.* or .*\\..*
●canal schema下所有表：canal\\..*
●canal下的以canal打头的表：canal\\.canal.*
●canal schema下的一张表：canal\\.test1
●多个规则组合使用：canal\\..*,mysql.test1,mysql.test2 (逗号分隔)
**注：**多个正则之间以逗号(,)分隔，转义符需要双斜杠(\\)

### 6.错误处理

如果canal启动时候从日志看到报这个错误：**can't find start position for example。**有如下解决方法：
**●单机**
删除meta.dat文件，重启canal，问题解决。
**●集群**
进入canal对应的zookeeper集群下，删除节点/otter/canal/destinations/实例/1001/cursor，重启canal即可恢复（不懂命令可以到zookeeper官网或者百度查找操作命令）。

参考文献：
[Canal Kafka/RocketMQ QuickStart](https://github.com/alibaba/canal/wiki/Canal-Kafka-RocketMQ-QuickStart)
[AdminGuide](https://github.com/alibaba/canal/wiki/AdminGuide)



# 关于的封面、封底

>  - 有关「封面、封底」，以及 VLOOK™ 的更多信息，详见《[VLOOK 快速参考手册](https://madmaxchow.github.io/VLOOK/guide.html#封面、封底)》
>  - 若你的文档不需要封面、封底，可以将本文档中开始位置的 6 级标题，以及结束位置的 1 级标题内容删除即可。

# The End